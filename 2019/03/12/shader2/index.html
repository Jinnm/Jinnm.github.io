<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>描边shader再探讨 | Codemoph</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="之前的一篇描边shader只是讲了实现的大致思路，但是实际去实现一个普通的角色描边shader的话，会发现很多很多的问题……普通的描边感觉比较好也比较常用的方式是用两个pass，底下那层在屏幕空间沿法线外扩，且剔除正面，上面那层用普通的。但是真的使用起来会用很多很麻烦的事。一、关于是否只要外轮廓图一为只要外轮廓，图二为中间也要，注意看手，手这个角度在外轮廓中，但也有描边。如果只要外轮廓，轮廓内部的"><meta name="keywords" content="Shader"><meta property="og:type" content="article"><meta property="og:title" content="描边shader再探讨"><meta property="og:url" content="https://jinnm.github.io/2019/03/12/shader2/index.html"><meta property="og:site_name" content="Codemoph"><meta property="og:description" content="之前的一篇描边shader只是讲了实现的大致思路，但是实际去实现一个普通的角色描边shader的话，会发现很多很多的问题……普通的描边感觉比较好也比较常用的方式是用两个pass，底下那层在屏幕空间沿法线外扩，且剔除正面，上面那层用普通的。但是真的使用起来会用很多很麻烦的事。一、关于是否只要外轮廓图一为只要外轮廓，图二为中间也要，注意看手，手这个角度在外轮廓中，但也有描边。如果只要外轮廓，轮廓内部的"><meta property="og:locale" content="en"><meta property="og:image" content="http://ws1.sinaimg.cn/large/006tKfTcly1g10bsluy9fj30ey0ew44t.jpg"><meta property="og:image" content="http://ws4.sinaimg.cn/large/006tKfTcly1g10bsl95zoj30en0epag3.jpg"><meta property="og:image" content="http://ws1.sinaimg.cn/large/006tKfTcly1g10bsj35gmj30mk0d2442.jpg"><meta property="og:image" content="http://ws2.sinaimg.cn/large/006tKfTcly1g10bsh924vj30b708wn22.jpg"><meta property="og:image" content="http://ws2.sinaimg.cn/large/006tKfTcly1g10bsf840aj30ag0a5dfz.jpg"><meta property="og:image" content="http://ws2.sinaimg.cn/large/006tKfTcly1g11epxjlk7j30eq05574d.jpg"><meta property="og:image" content="http://ws2.sinaimg.cn/large/006tKfTcly1g11epzs98uj30w80cyq5u.jpg"><meta property="og:image" content="http://ws3.sinaimg.cn/large/006tKfTcly1g10bsf0i3nj30br0b3acy.jpg"><meta property="og:image" content="http://ws2.sinaimg.cn/large/006tKfTcly1g10bse849cj30a309agnm.jpg"><meta property="og:image" content="http://ws4.sinaimg.cn/large/006tKfTcly1g10bsdaqj4j30au09cwgl.jpg"><meta property="og:updated_time" content="2019-06-09T10:35:16.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="描边shader再探讨"><meta name="twitter:description" content="之前的一篇描边shader只是讲了实现的大致思路，但是实际去实现一个普通的角色描边shader的话，会发现很多很多的问题……普通的描边感觉比较好也比较常用的方式是用两个pass，底下那层在屏幕空间沿法线外扩，且剔除正面，上面那层用普通的。但是真的使用起来会用很多很麻烦的事。一、关于是否只要外轮廓图一为只要外轮廓，图二为中间也要，注意看手，手这个角度在外轮廓中，但也有描边。如果只要外轮廓，轮廓内部的"><meta name="twitter:image" content="http://ws1.sinaimg.cn/large/006tKfTcly1g10bsluy9fj30ey0ew44t.jpg"><link rel="icon" href="/favicon.png"><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"></head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">C </span><span class="w">o </span><span class="b">d </span><span class="w">e </span><span class="b">m </span><span class="b">o </span><span class="w">p </span><span class="b">h </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-shader2" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">描边shader再探讨</h1><div class="article-meta">Posted on <time class="article-time" datetime="2019-03-12T13:10:50.000Z" itemprop="datePublished">Mar 12, 2019</time></div></header><div class="article-entry" itemprop="articleBody"><p>之前的一篇描边shader只是讲了实现的大致思路，但是实际去实现一个普通的角色描边shader的话，会发现很多很多的问题……</p><p>普通的描边感觉比较好也比较常用的方式是用两个pass，底下那层在屏幕空间沿法线外扩，且剔除正面，上面那层用普通的。<br>但是真的使用起来会用很多很麻烦的事。</p><h3 id="一、关于是否只要外轮廓"><a href="#一、关于是否只要外轮廓" class="headerlink" title="一、关于是否只要外轮廓"></a>一、关于是否只要外轮廓</h3><p>图一为只要外轮廓，图二为中间也要，注意看手，手这个角度在外轮廓中，但也有描边。<br><img src="http://ws1.sinaimg.cn/large/006tKfTcly1g10bsluy9fj30ey0ew44t.jpg" alt><br><img src="http://ws4.sinaimg.cn/large/006tKfTcly1g10bsl95zoj30en0epag3.jpg" alt></p><p>如果只要外轮廓，轮廓内部的描边不要的话，可以在第一个pass设置ZWrite off，后一个pass就可以严严实实的盖住它，只露出旁边一圈。<br>关闭深度写入很省心但是会有很多问题，比如Geometry之后会有天空盒的渲染，就会把深度未写入的描边给盖住，就需要调整渲染队列，然后又会带来新的问题……这个时候这个做法就已经不经济了。另一个方法是用Offset指令控制深度测试，让后面的描边颜色稍稍靠后一点。但是往后多少呢，少了的话，一部分面片穿插不能解决，多了的话，角色后面有个靠的很近的物体可能就会出问题……</p><p>而如果要内部描边的话，让一些背面的渲染结果“露出来”，就会因为模型的缘故出现各种奇奇怪怪的问题，严重的比如……<br><img src="http://ws1.sinaimg.cn/large/006tKfTcly1g10bsj35gmj30mk0d2442.jpg" alt></p><p>即便模型建的比较规范，没有严重的面片穿插问题，也会出现一些描边位置奇怪的问题，比如<br><img src="http://ws2.sinaimg.cn/large/006tKfTcly1g10bsh924vj30b708wn22.jpg" alt></p><p>你会感觉你希望的描边并不是这样的……不过想做到这个要求就比较高了，计算机视觉这方面要做的好都需要复杂得多的算法，比如用双阈值判断是否连接……而且关于哪些地方应该描边有很多主观的因素，想象你自己在一张原画上画，很多地方该不该描也要犹豫。</p><h3 id="二、关于如何解决面片割裂开"><a href="#二、关于如何解决面片割裂开" class="headerlink" title="二、关于如何解决面片割裂开"></a>二、关于如何解决面片割裂开</h3><p>就是沿法线外扩的时候，面片会分开，像这样：<br><img src="http://ws2.sinaimg.cn/large/006tKfTcly1g10bsf840aj30ag0a5dfz.jpg" alt></p><p>如果外扩不是很多的话，可以将要外扩的方向和这个点相对于模型中心的方向lerp一下，可以改善一点点……<br>另外有个方法是在导入设置中设置法线为calculate<br><img src="http://ws2.sinaimg.cn/large/006tKfTcly1g11epxjlk7j30eq05574d.jpg" alt><br>但是这么做一方面比较费，另一方面效果还是要看情况，比如修改前修改后分别是这个效果<br><img src="http://ws2.sinaimg.cn/large/006tKfTcly1g11epzs98uj30w80cyq5u.jpg" alt></p><p>要效果好一点，就需要对美术资源下手，比如崩坏3就是这样做的：</p><blockquote><p>接下来让我们来谈谈高品质勾线的方法，对于角色和动态物体我们使用backface勾线方法，并使用顶点色对勾线的宽度进行控制，勾线本身需要连续的顶点法线才能在锐角边不会出现断层，因此我们将平滑过的法线存储在另一套顶点色里，此外，我们也使用顶点色来控制勾线宽度，比如，发尖处勾线会逐渐变细，我们通过在顶点颜色填充渐变为0的值以使线条宽度逐渐过渡到零，另外，根据相机与物体之间的距离，还应有基于距离修正的勾线宽度。每种材质上也应该有对应的不同勾线颜色， 所有这些功能都是高品质的勾线所必需的。</p></blockquote><p>实际上在一般的描边粗细条件下，大部分模型的断裂现象不明显，但是头发由于发尾比较尖细就会很明显，参考崩坏顶点色的做法，可以直接给发尾的顶点色改成黑色，第一个pass延发现外扩的距离*顶点色，这样发尾描边就不会断开，而且发尾原本描边就是细一点好看。</p><h3 id="三、关于描边是否渐变"><a href="#三、关于描边是否渐变" class="headerlink" title="三、关于描边是否渐变"></a>三、关于描边是否渐变</h3><p>有些时候需要描边往内渐隐，会有一种发光感<br><img src="http://ws3.sinaimg.cn/large/006tKfTcly1g10bsf0i3nj30br0b3acy.jpg" alt></p><p>第一反应：简单啊，就是另一种描边的方式，根据法线和视线夹角的值加描边，角色的边缘和视线的值差不多是九十度。但是还有另外一个要求，只要外轮廓，中间不要加……如果按之前想的方法，中间所有凸起的地方旁边都会有一圈发光描边，就不符合要求了。</p><p>第一个想法：第一个pass外扩，第二个pass往内缩一些，然后把第一个pass的渐变限制在露出来的那一截。实际操作的时候，由于露出来的那一截需要比较宽的一段，顶点沿法线移动太多导致很多面片分离以及穿插的问题……</p><p>第二个想法：用模型空间的坐标做判断，设计一个函数使得，顶点离原点越近，描边影响就越小，同时x轴上的影响更剧烈一些（因为这个shader用在角色上，x轴比较短，y轴比较长）。这样的话，角色一旦是张开手臂的话，手臂上就没有描边了……而且因为头和身子头发都是分开的mesh，也会有问题，随着角色形象的变化还有很多很多问题………总的来说这个方法太过“定制化”了，毫无实用性。</p><p>第三个想法：一般中间不需要描边的部分离摄影机更近，所以可以计算顶点与摄像机的距离，同时计算模型上的(0, y, 0)点与摄像机的距离，两个距离差值越大，描边越弱。这个效果相对来说还可以。<br><img src="http://ws2.sinaimg.cn/large/006tKfTcly1g10bse849cj30a309agnm.jpg" alt><br><img src="http://ws4.sinaimg.cn/large/006tKfTcly1g10bsdaqj4j30au09cwgl.jpg" alt></p><p>但是也会有很多的问题<br>1、中心即便突出一些，也突出的很少，需要比较高的精度<br>2、不同角色差异会很大<br>3、当角色斜侧着身子就会不符合想要的效果。比如像上图这个角度，最左边的左手和最右边的头发应该是同等的描边效果，然而它们分别是离摄像机最远的一点和最近的一点。</p><h3 id="四、关于使用后处理"><a href="#四、关于使用后处理" class="headerlink" title="四、关于使用后处理"></a>四、关于使用后处理</h3><p>其实用后处理很多时候效果会好很多，毕竟发生的很多问题都是3D方面的问题……然而因为后处理太费，尤其是对于移动端，这是一种尽量不要去考虑的方式……<br>后处理的方式就是添加一个额外相机，复制原相机属性，只将需要描边的物体渲染在RT，可以通过layer指定渲染物体。然后将RT扩展出外边，类似高斯模糊，如果不想要渐变的描边效果可以做判断，只要大于0就算描边区域（记得用step不要用if）</p><h3 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h3><p>目前没有非常完美的方案，要结合实际使用情况选择一种相对来说效果好一些的方案。但相对来说，2pass的方法+描边调细+特殊情况配合顶点色 是最不错也最常见的方案了。</p></div><div class="article-tags"><a class="tag-link" href="/tagsfol/Shader/">Shader</a></div></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="https://jinnm.github.io">Codemoph</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a href="https://hexo.io/" rel="external">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix" style="display:none"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc" style="display:none"><div class="no-index">No Index</div></div><div class="site-bio show" style="display:block"><div class="about-me clearfix"><div class="avatar"><img src="/img/avatar.png"></div><div class="info"><a class="name dark-btn" href="/2018/04/29/AboutMe/">Jinnm</a></div><div class="info"><span class="item desc"></span></div></div><div class="social clearfix"></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script>document.getElementById("loading-bar").style.width="100%"</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>