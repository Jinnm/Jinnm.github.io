<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>简易IBL渲染 | Codemoph</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="通过一个Cubemap，使用IBL可以渲染出非常接近Unity Standard Shader的效果。常用DCC工具中实时渲染效果最好的大概是Substance Painter，它采用的就是IBL，不过是算法更加复杂，更接近真实的IBL。这里提供一种实现简易IBL的思路，尤其在移动端平台中，合理使用IBL可以使性能和效果达到非常好的平衡。第一个思路diffuse部分：1fixed3 indirec"><meta name="keywords" content="Shader"><meta property="og:type" content="article"><meta property="og:title" content="简易IBL渲染"><meta property="og:url" content="https://jinnm.github.io/2019/06/22/shader5/index.html"><meta property="og:site_name" content="Codemoph"><meta property="og:description" content="通过一个Cubemap，使用IBL可以渲染出非常接近Unity Standard Shader的效果。常用DCC工具中实时渲染效果最好的大概是Substance Painter，它采用的就是IBL，不过是算法更加复杂，更接近真实的IBL。这里提供一种实现简易IBL的思路，尤其在移动端平台中，合理使用IBL可以使性能和效果达到非常好的平衡。第一个思路diffuse部分：1fixed3 indirec"><meta property="og:locale" content="en"><meta property="og:image" content="http://ww3.sinaimg.cn/large/006tNc79gy1g49xiexzaij30lc0bnat8.jpg"><meta property="og:image" content="http://ww2.sinaimg.cn/large/006tNc79gy1g49xietva6j30lh0bnamu.jpg"><meta property="og:image" content="http://ww3.sinaimg.cn/large/006tNc79gy1g49xieoqckj30lk0apk5c.jpg"><meta property="og:image" content="http://ww2.sinaimg.cn/large/006tNc79gy1g49xiekid4j30mj08qagn.jpg"><meta property="og:image" content="http://ww4.sinaimg.cn/large/006tNc79gy1g49xiehao4j30k00b7tju.jpg"><meta property="og:image" content="http://ww2.sinaimg.cn/large/006tNc79gy1g49xiec6l0j30jy0axqg3.jpg"><meta property="og:image" content="http://ww4.sinaimg.cn/large/006tNc79gy1g49xie95c0j30jv0aqqga.jpg"><meta property="og:image" content="http://ww3.sinaimg.cn/large/006tNc79gy1g49xie2y76j30k70akwol.jpg"><meta property="og:updated_time" content="2019-06-22T07:03:06.272Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="简易IBL渲染"><meta name="twitter:description" content="通过一个Cubemap，使用IBL可以渲染出非常接近Unity Standard Shader的效果。常用DCC工具中实时渲染效果最好的大概是Substance Painter，它采用的就是IBL，不过是算法更加复杂，更接近真实的IBL。这里提供一种实现简易IBL的思路，尤其在移动端平台中，合理使用IBL可以使性能和效果达到非常好的平衡。第一个思路diffuse部分：1fixed3 indirec"><meta name="twitter:image" content="http://ww3.sinaimg.cn/large/006tNc79gy1g49xiexzaij30lc0bnat8.jpg"><link rel="icon" href="/favicon.png"><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"></head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">C </span><span class="w">o </span><span class="b">d </span><span class="w">e </span><span class="b">m </span><span class="b">o </span><span class="w">p </span><span class="b">h </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-shader5" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">简易IBL渲染</h1><div class="article-meta">Posted on <time class="article-time" datetime="2019-06-22T06:32:38.000Z" itemprop="datePublished">Jun 22, 2019</time></div></header><div class="article-entry" itemprop="articleBody"><p>通过一个Cubemap，使用IBL可以渲染出非常接近Unity Standard Shader的效果。常用DCC工具中实时渲染效果最好的大概是Substance Painter，它采用的就是IBL，不过是算法更加复杂，更接近真实的IBL。这里提供一种实现简易IBL的思路，尤其在移动端平台中，合理使用IBL可以使性能和效果达到非常好的平衡。</p><h3 id="第一个思路"><a href="#第一个思路" class="headerlink" title="第一个思路"></a>第一个思路</h3><p>diffuse部分：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fixed3 indirectDiffuse = texCUBElod(_IBLCube, float4(normal, _LodLevel)) * albedo;</span><br></pre></td></tr></table></figure><p>这里使用5的LOD Level对Cubemap进行采样（视效果调节）</p><p>specular部分：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fixed3 indirectSpec = texCUBElod(_IBLCube, float4(reflection, _Gloss));</span><br></pre></td></tr></table></figure><p>按照光滑度对cubemap进行采样，越粗糙反射结果就越模糊</p><p>两者根据金属度做lerp混合，即kS = Metalic，kD = 1 - Metalic</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lerp(indirectDiffuse, indirectSpec, _Metalic)</span><br></pre></td></tr></table></figure><p>这个思路是一个非常简单直接的经验模型，效果是这样：<br>以右边的Standard Shader效果作为对比，发现diffuse部分暗很多，以及发现还少了菲涅尔的效果<br><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g49xiexzaij30lc0bnat8.jpg" alt><br><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g49xietva6j30lh0bnamu.jpg" alt><br><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g49xieoqckj30lk0apk5c.jpg" alt><br>实际上用这个方案，在diffuse和specular上乘两个可调参数控制一下强度，已经可以达到比较好看的效果了。</p><h3 id="改进Diffuse"><a href="#改进Diffuse" class="headerlink" title="改进Diffuse"></a>改进Diffuse</h3><p>diffuse部分会偏暗是由于对cubemap直接做了降采样处理，而正确的做法会比较接近这种情况：<br><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g49xiekid4j30mj08qagn.jpg" alt><br>右边的这种卷积处理比普通的降采样亮很多，会”强调”cubemap中的光照部分，更好的表现了光照信息。<br>Unity中是采用球谐函数计算的，这里直接使用Unity的函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fixed3 indirectDiffuse = ShadeSH9(float4(normal,1)) * albedo;</span><br></pre></td></tr></table></figure><p><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g49xiehao4j30k00b7tju.jpg" alt><br><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g49xiec6l0j30jy0axqg3.jpg" alt><br>当albedo为白色时，会发现diffuse的部分比起之前的效果看起来“正确”了许多，但是还缺少菲涅尔，在albedo为黑色时尤其明显。</p><h3 id="添加菲涅尔"><a href="#添加菲涅尔" class="headerlink" title="添加菲涅尔"></a>添加菲涅尔</h3><p>这里参考了 <a href="https://learnopengl.com/PBR/IBL/Specular-IBL" target="_blank" rel="noopener">LearnOpenGL的IBL教程</a> 的做法，最后使用的镜面反射部分是这篇文章方法的简化版。<br>菲涅尔的计算如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fixed3 fresnelSchlickRoughness(float cosTheta, fixed3 F0, float glossness)</span><br><span class="line">&#123;</span><br><span class="line">    return F0 + (max(glossness * fixed3(1,1,1), F0) - F0) * pow(1.0 - cosTheta, 5.0);</span><br><span class="line">&#125;</span><br><span class="line">fixed3 F0 = lerp(fixed3(0.04, 0.04, 0.04), _Color, _Metalic);    //非金属也有0.04的镜面反射</span><br><span class="line">fixed3 fresnel = fresnelSchlickRoughness(NdV, F0, _Gloss);</span><br></pre></td></tr></table></figure><p>镜面反射系数就是菲涅尔，即kS = fresnel，漫反射系数为kD = (1 - kS)*(1 - Metalic)，效果是这样：<br><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g49xie95c0j30jv0aqqga.jpg" alt><br><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g49xie2y76j30k70akwol.jpg" alt><br>可以发现有了菲涅尔之后，效果非常接近了，当然要达到更好的效果还需要更加细致的计算。</p></div><div class="article-tags"><a class="tag-link" href="/tagsfol/Shader/">Shader</a></div></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="https://jinnm.github.io">Codemoph</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a href="https://hexo.io/" rel="external">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix" style="display:none"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc" style="display:none"><div class="no-index">No Index</div></div><div class="site-bio show" style="display:block"><div class="about-me clearfix"><div class="avatar"><img src="/img/avatar.png"></div><div class="info"><a class="name dark-btn" href="/2018/04/29/AboutMe/">Jinnm</a></div><div class="info"><span class="item desc"></span></div></div><div class="social clearfix"></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script>document.getElementById("loading-bar").style.width="100%"</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>