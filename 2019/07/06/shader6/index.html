<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>UE4移动端卡通渲染 | Codemoph</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="前期准备最近学习UE4，尝试改UE4引擎，做一个cartoon的shading model。使用的UE4版本是4.19。首先需要有源码版的UE4引擎，根据这篇UE4官方文档，去Github把源码pull下来。然后根据这篇官方文档从源码构建引擎。我这里在vs上踩了坑，除了要装c++桌面开发的unreal相关外，还要在.NET桌面开发中勾上.NET Framework 4.6.2。以及可以根据这篇博文"><meta name="keywords" content="Shader"><meta property="og:type" content="article"><meta property="og:title" content="UE4移动端卡通渲染"><meta property="og:url" content="https://jinnm.github.io/2019/07/06/shader6/index.html"><meta property="og:site_name" content="Codemoph"><meta property="og:description" content="前期准备最近学习UE4，尝试改UE4引擎，做一个cartoon的shading model。使用的UE4版本是4.19。首先需要有源码版的UE4引擎，根据这篇UE4官方文档，去Github把源码pull下来。然后根据这篇官方文档从源码构建引擎。我这里在vs上踩了坑，除了要装c++桌面开发的unreal相关外，还要在.NET桌面开发中勾上.NET Framework 4.6.2。以及可以根据这篇博文"><meta property="og:locale" content="en"><meta property="og:image" content="http://ww1.sinaimg.cn/large/006tNc79ly1g4py28hc60j303904zt8l.jpg"><meta property="og:image" content="http://ww1.sinaimg.cn/large/006tNc79ly1g4py28bvtlj304v04y0st.jpg"><meta property="og:image" content="http://ww4.sinaimg.cn/large/006tNc79ly1g4py284fm5j30u00yr49a.jpg"><meta property="og:updated_time" content="2019-07-06T03:24:26.290Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="UE4移动端卡通渲染"><meta name="twitter:description" content="前期准备最近学习UE4，尝试改UE4引擎，做一个cartoon的shading model。使用的UE4版本是4.19。首先需要有源码版的UE4引擎，根据这篇UE4官方文档，去Github把源码pull下来。然后根据这篇官方文档从源码构建引擎。我这里在vs上踩了坑，除了要装c++桌面开发的unreal相关外，还要在.NET桌面开发中勾上.NET Framework 4.6.2。以及可以根据这篇博文"><meta name="twitter:image" content="http://ww1.sinaimg.cn/large/006tNc79ly1g4py28hc60j303904zt8l.jpg"><link rel="icon" href="/favicon.png"><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"></head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">C </span><span class="w">o </span><span class="b">d </span><span class="w">e </span><span class="b">m </span><span class="b">o </span><span class="w">p </span><span class="b">h </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-shader6" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">UE4移动端卡通渲染</h1><div class="article-meta">Posted on <time class="article-time" datetime="2019-07-06T02:38:20.000Z" itemprop="datePublished">Jul 6, 2019</time></div></header><div class="article-entry" itemprop="articleBody"><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><p>最近学习UE4，尝试改UE4引擎，做一个cartoon的shading model。使用的UE4版本是4.19。</p><p>首先需要有源码版的UE4引擎，根据<a href="https://docs.unrealengine.com/zh-CN/GettingStarted/DownloadingUnrealEngine/index.html" target="_blank" rel="noopener">这篇UE4官方文档</a>，去Github把源码pull下来。然后根据<a href="https://docs.unrealengine.com/zh-CN/Programming/Development/BuildingUnrealEngine/index.html" target="_blank" rel="noopener">这篇官方文档</a>从源码构建引擎。我这里在vs上踩了坑，除了要装c++桌面开发的unreal相关外，还要在.NET桌面开发中勾上.NET Framework 4.6.2。以及可以根据<a href="https://medium.com/@lordned/unreal-engine-4-rendering-overview-part-1-c47f2da65346" target="_blank" rel="noopener">这篇博文</a>做一些修改，装一些实用工具，其中的六篇还有六篇教程，对新手入门UE4非常有帮助。</p><p>接下来主要参考<a href="https://zhuanlan.zhihu.com/p/36840778" target="_blank" rel="noopener">这篇文章</a>实际上他也是根据上面Medium的教程做的。但是这篇教程是针对PC端的，PC端和Mobile使用的是完全不一样的渲染管线，这里新做一个shading model参考一下他们的做法，然后自己研究了一下改mobile。</p><h3 id="添加新的shading-model"><a href="#添加新的shading-model" class="headerlink" title="添加新的shading model"></a>添加新的shading model</h3><p>在以下文件中分别做如下修改</p><p>EngineTypes.h</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">UENUM()</span><br><span class="line">enum EMaterialShadingModel</span><br><span class="line">&#123;</span><br><span class="line">       MSM_Unlit                         UMETA(DisplayName=&quot;Unlit&quot;),</span><br><span class="line">       MSM_DefaultLit                    UMETA(DisplayName=&quot;Default Lit&quot;),</span><br><span class="line">       MSM_Subsurface                    UMETA(DisplayName=&quot;Subsurface&quot;),</span><br><span class="line">       MSM_PreintegratedSkin      UMETA(DisplayName=&quot;Preintegrated Skin&quot;),</span><br><span class="line">       MSM_ClearCoat              UMETA(DisplayName=&quot;Clear Coat&quot;),</span><br><span class="line">       MSM_SubsurfaceProfile      UMETA(DisplayName=&quot;Subsurface Profile&quot;),</span><br><span class="line">       MSM_TwoSidedFoliage        UMETA(DisplayName=&quot;Two Sided Foliage&quot;),</span><br><span class="line">       MSM_Hair                          UMETA(DisplayName=&quot;Hair&quot;),</span><br><span class="line">       MSM_Cloth                         UMETA(DisplayName=&quot;Cloth&quot;),</span><br><span class="line">       MSM_Eye                                  UMETA(DisplayName=&quot;Eye&quot;),</span><br><span class="line">       **MSM_Toon                          UMETA(DisplayName = &quot;Toon&quot;),**</span><br><span class="line">       MSM_MAX,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>MaterialShared.cpp</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">switch(GetShadingModel())</span><br><span class="line">&#123;</span><br><span class="line">       ...</span><br><span class="line">    case MSM_Eye:    OutEnvironment.SetDefine(TEXT(&quot;MATERIAL_SHADINGMODEL_EYE&quot;),     TEXT(&quot;1&quot;)); break;</span><br><span class="line">    **case MSM_Toon:   OutEnvironment.SetDefine(TEXT(&quot;MATERIAL_SHADINGMODEL_TOON&quot;),    TEXT(&quot;1&quot;)); break;**</span><br><span class="line">    default:</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>DeferredShadingCommon.ush</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#define SHADINGMODELID_UNLIT                           0</span><br><span class="line">#define SHADINGMODELID_DEFAULT_LIT                     1</span><br><span class="line">#define SHADINGMODELID_SUBSURFACE                      2</span><br><span class="line">#define SHADINGMODELID_PREINTEGRATED_SKIN              3</span><br><span class="line">#define SHADINGMODELID_CLEAR_COAT                      4</span><br><span class="line">#define SHADINGMODELID_SUBSURFACE_PROFILE              5</span><br><span class="line">#define SHADINGMODELID_TWOSIDED_FOLIAGE                6</span><br><span class="line">#define SHADINGMODELID_HAIR                            7</span><br><span class="line">#define SHADINGMODELID_CLOTH                           8</span><br><span class="line">#define SHADINGMODELID_EYE                             9</span><br><span class="line">**#define SHADINGMODELID_TOON                            10**</span><br><span class="line">#define SHADINGMODELID_NUM                             11</span><br><span class="line">#define SHADINGMODELID_MASK                            0xF</span><br></pre></td></tr></table></figure><p>这样就可以使用自己的shading model了<br><img src="http://ww1.sinaimg.cn/large/006tNc79ly1g4py28hc60j303904zt8l.jpg" alt></p><h3 id="接口名称修改"><a href="#接口名称修改" class="headerlink" title="接口名称修改"></a>接口名称修改</h3><p>在Material.cpp中想要的接口处添加自己的shading model，如想要customdata0接口，这样添加这个接口就被激活了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">case MP_CustomData0:</span><br><span class="line">              Active = ShadingModel == MSM_ClearCoat || ShadingModel == MSM_Hair  || ShadingModel == MSM_Cloth || ShadingModel == MSM_Eye || **ShadingModel ==  MSM_Toon;**</span><br></pre></td></tr></table></figure><p>然后修改接口的名字，在MaterialGragh.cpp中，比如修改metallic接口名，找到这个函数，改成这样</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FText UMaterialGraph::GetMetallicPinName() const</span><br><span class="line">&#123;</span><br><span class="line">       switch (Material-&gt;GetShadingModel())</span><br><span class="line">       &#123;</span><br><span class="line">       **case MSM_Toon:</span><br><span class="line">              return LOCTEXT(&quot;ShadowStrength&quot;, &quot;Shadow Strength&quot;);**</span><br><span class="line">       default:</span><br><span class="line">              return Material-&gt;GetShadingModel() == MSM_Hair ? LOCTEXT(&quot;Scatter&quot;,  &quot;Scatter&quot;) : LOCTEXT(&quot;Metallic&quot;, &quot;Metallic&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>想改specular或roughness的话，由于没有这个函数，需要自己添加，添加后在此处调用函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MaterialInputs.Add( FMaterialInputInfo( GetBaseColorPinName(),  MP_BaseColor, LOCTEXT( &quot;BaseColorToolTip&quot;, &quot;Defines the overall color of the  Material. Each channel is automatically clamped between 0 and 1&quot; ) ) );</span><br><span class="line">MaterialInputs.Add( FMaterialInputInfo( GetMetallicPinName(),  MP_Metallic, LOCTEXT( &quot;MetallicToolTip&quot;, &quot;Controls how \&quot;metal-like\&quot; your surface  looks like&quot;) ) );</span><br><span class="line">MaterialInputs.Add( FMaterialInputInfo( **GetSpecularPinName()**,  MP_Specular, LOCTEXT(&quot;SpecularToolTip&quot;, &quot;Used to scale the current amount of  specularity on non-metallic surfaces and is a value between 0 and 1, default at  0.5&quot;) ) );</span><br><span class="line">MaterialInputs.Add( FMaterialInputInfo( **GetRoughnessPinName()**,  MP_Roughness, LOCTEXT( &quot;RoughnessToolTip&quot;, &quot;Controls how rough the Material is.  Roughness of 0 (smooth) is a mirror reflection and 1 (rough) is completely matte  or diffuse&quot; ) ) );</span><br></pre></td></tr></table></figure><p>另外在MaterialGragh.h中需要添加新函数的声明，这样接口就变成了这样<br><img src="http://ww1.sinaimg.cn/large/006tNc79ly1g4py28bvtlj304v04y0st.jpg" alt></p><h3 id="贴图采样"><a href="#贴图采样" class="headerlink" title="贴图采样"></a>贴图采样</h3><p>mobile使用的就是前向渲染，主要实现基本在MobileBasePassPixelShader.usf中，用宏MATERIAL_SHADINGMODEL_TOON控制toon要进行的计算和不需要进行的，关键的几个数据N、L、V、Shadow原本代码里就已经算过了，可以直接用，关键在于如何自己采样贴图，想办法获取到从接口输入的贴图。</p><p>先顺着basecolor的来源，发现来源于PixelMaterialInputs中的数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">half3 GetMaterialBaseColorRaw(FPixelMaterialInputs PixelMaterialInputs)</span><br><span class="line">&#123;</span><br><span class="line">       return PixelMaterialInputs.BaseColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后发现PixelMaterialInputs的定义是这样的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct FPixelMaterialInputs</span><br><span class="line">&#123;</span><br><span class="line">%s</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>%s处是根据用户的蓝图填充进去的，于是自己连了一个材质，看了一下生成的hlsl，找到一处关键代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MaterialFloat4 Local0 = ProcessMaterialColorTextureLookup(Texture2DSampleBias(**Material.Texture2D_0**,Material.Texture2D_0Sampler,Parameters.TexCoords[0].xy,View.MaterialTextureMipBias));</span><br><span class="line">PixelMaterialInputs.BaseColor = Local0.rgb;</span><br></pre></td></tr></table></figure><p>于是在MobileBasePassPixelShader.usf中尝试用Material.Texture2D_0当贴图用，结果真的可以直接用，后面的编号应该是内存中贴图的顺序，先被接入贴图的节点中的贴图排前面，比如emissive节点先被接入一张贴图，那么它就是_0，后面接入新的贴图节点只是给原来的_0贴图重新赋值。所以使用这个shading model的话要注意贴图的连入顺序。应该是有个地方有绑定之类的操作，但这样改起来非常复杂，可以直接给引擎组的人提需求了……</p><p>最后就可以使用了，这是一个使用ramp图做暗部映射，另外添加一个边缘光的卡通shading model<br><img src="http://ww4.sinaimg.cn/large/006tNc79ly1g4py284fm5j30u00yr49a.jpg" alt></p></div><div class="article-tags"><a class="tag-link" href="/tagsfol/Shader/">Shader</a></div></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="https://jinnm.github.io">Codemoph</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a href="https://hexo.io/" rel="external">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix" style="display:none"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc" style="display:none"><div class="no-index">No Index</div></div><div class="site-bio show" style="display:block"><div class="about-me clearfix"><div class="avatar"><img src="/img/avatar.png"></div><div class="info"><a class="name dark-btn" href="/2018/04/29/AboutMe/">Jinnm</a></div><div class="info"><span class="item desc"></span></div></div><div class="social clearfix"></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script>document.getElementById("loading-bar").style.width="100%"</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>