<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>移动端枪击受伤效果(二) | Codemoph</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="原本的版本主要有两个很费或是影响低配机效果的地方，一是使用了两次vtf，一次是为了获取终点mesh的顶点法线，对顶点法线也做morgh，一次是为了获取射击点。二是shader会不停的遍历所有的射击点计算距离，对于旧的射击点，很多计算是重复的。干掉VTF如果不对法线做morgh的区别大概是这样(左边没有使用终点mesh法线，右边使用了)以这个丧尸模型为例的话，主要的区别在胸腔，没用使用终点mesh法"><meta name="keywords" content="Shader"><meta property="og:type" content="article"><meta property="og:title" content="移动端枪击受伤效果(二)"><meta property="og:url" content="https://jinnm.github.io/2019/08/02/MeshTransformation2/index.html"><meta property="og:site_name" content="Codemoph"><meta property="og:description" content="原本的版本主要有两个很费或是影响低配机效果的地方，一是使用了两次vtf，一次是为了获取终点mesh的顶点法线，对顶点法线也做morgh，一次是为了获取射击点。二是shader会不停的遍历所有的射击点计算距离，对于旧的射击点，很多计算是重复的。干掉VTF如果不对法线做morgh的区别大概是这样(左边没有使用终点mesh法线，右边使用了)以这个丧尸模型为例的话，主要的区别在胸腔，没用使用终点mesh法"><meta property="og:locale" content="en"><meta property="og:image" content="http://ww2.sinaimg.cn/large/006tNc79gy1g5l4dcavrij31210u0nl3.jpg"><meta property="og:image" content="http://ww1.sinaimg.cn/large/006tNc79gy1g5l4dc1opnj30vn0u04kx.jpg"><meta property="og:image" content="http://ww3.sinaimg.cn/large/006tNc79gy1g5l4dbrcs0j319i0q6qut.jpg"><meta property="og:image" content="http://ww3.sinaimg.cn/large/006tNc79gy1g5l4fhjru9j319e0ps77y.jpg"><meta property="og:image" content="http://ww4.sinaimg.cn/large/006tNc79gy1g5l4fhaaxzj319y0oyjv1.jpg"><meta property="og:image" content="http://ww4.sinaimg.cn/large/006tNc79gy1g5l4fh5115j319k0o4tbw.jpg"><meta property="og:image" content="http://ww2.sinaimg.cn/large/006tNc79gy1g5l4fgwllwj319o0oaad9.jpg"><meta property="og:image" content="http://ww4.sinaimg.cn/large/006tNc79gy1g5l4dbn1btj30ar02o744.jpg"><meta property="og:image" content="http://ww4.sinaimg.cn/large/006tNc79gy1g5l4mpoxftj31co0pc7cs.jpg"><meta property="og:image" content="http://ww2.sinaimg.cn/large/006tNc79gy1g5l4obu378j31860o4juj.jpg"><meta property="og:updated_time" content="2019-08-02T02:33:00.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="移动端枪击受伤效果(二)"><meta name="twitter:description" content="原本的版本主要有两个很费或是影响低配机效果的地方，一是使用了两次vtf，一次是为了获取终点mesh的顶点法线，对顶点法线也做morgh，一次是为了获取射击点。二是shader会不停的遍历所有的射击点计算距离，对于旧的射击点，很多计算是重复的。干掉VTF如果不对法线做morgh的区别大概是这样(左边没有使用终点mesh法线，右边使用了)以这个丧尸模型为例的话，主要的区别在胸腔，没用使用终点mesh法"><meta name="twitter:image" content="http://ww2.sinaimg.cn/large/006tNc79gy1g5l4dcavrij31210u0nl3.jpg"><link rel="icon" href="/favicon.png"><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"></head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">C </span><span class="w">o </span><span class="b">d </span><span class="w">e </span><span class="b">m </span><span class="b">o </span><span class="w">p </span><span class="b">h </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-MeshTransformation2" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">移动端枪击受伤效果(二)</h1><div class="article-meta">Posted on <time class="article-time" datetime="2019-08-02T02:15:08.000Z" itemprop="datePublished">Aug 2, 2019</time></div></header><div class="article-entry" itemprop="articleBody"><p>原本的版本主要有两个很费或是影响低配机效果的地方，一是使用了两次vtf，一次是为了获取终点mesh的顶点法线，对顶点法线也做morgh，一次是为了获取射击点。二是shader会不停的遍历所有的射击点计算距离，对于旧的射击点，很多计算是重复的。</p><h3 id="干掉VTF"><a href="#干掉VTF" class="headerlink" title="干掉VTF"></a>干掉VTF</h3><p>如果不对法线做morgh的区别大概是这样<br>(左边没有使用终点mesh法线，右边使用了)</p><p><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g5l4dcavrij31210u0nl3.jpg" alt><br><img src="http://ww1.sinaimg.cn/large/006tNc79gy1g5l4dc1opnj30vn0u04kx.jpg" alt></p><p>以这个丧尸模型为例的话，主要的区别在胸腔，没用使用终点mesh法线的胸腔正面看还是鼓鼓的，侧面看的话还是有凹陷的感觉。带来的问题就是，玩家在正面射击胸腔时，看起来只是皮被打掉了。如果制作模型时，胸腔位置的变化主要不是靠凹陷，而是躯干部分整个变小了，也就是尽量用顶点的变化来凸显射击的变化，这样即便没有变化法线，射击效果也是明显的。</p><p>大概改了一下模型，改成最右边截图中的效果，射击造成的变化有变明显一些</p><p><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g5l4dbrcs0j319i0q6qut.jpg" alt></p><p>而针对采样得到射击点位置，可以限制射击点数量，使用constant buffer传递射击点数组。constant buffer的大小是16kb-64kb，一般情况下射击数量不会超过100，这样占据buffer不会超过1.6kb，感觉还可以。<br>放弃使用终点mesh法线，而且使用constant buffer传递射击点位置后的真机测试结果如下：<br>同样是场景中只有一个模型，测试机为iPhone 6s</p><p>下图分别是0次、5次、10次、20次射击</p><p><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g5l4fhjru9j319e0ps77y.jpg" alt><br><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g5l4fhaaxzj319y0oyjv1.jpg" alt><br><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g5l4fh5115j319k0o4tbw.jpg" alt><br><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g5l4fgwllwj319o0oaad9.jpg" alt></p><p>对比之前在vs中采样得到法线贴图和射击点位置时的测试结果，提升还是比较明显的<br><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g5l4dbn1btj30ar02o744.jpg" alt></p><h3 id="干掉重复计算"><a href="#干掉重复计算" class="headerlink" title="干掉重复计算"></a>干掉重复计算</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">float p = 0;</span><br><span class="line"></span><br><span class="line">for (int ii = 0;ii &lt; _pointsLength; ii++) &#123;</span><br><span class="line">    //计算采样uv位置</span><br><span class="line">    float4 uvInBuffer = float4(</span><br><span class="line">        (ii % _ShootPointsSize + 0.5) / _ShootPointsSize*1.0,</span><br><span class="line">        (ii / _ShootPointsSize + 0.5) / _ShootPointsSize*1.0, 0, 0);</span><br><span class="line"></span><br><span class="line">    //采样得到第i个射击点</span><br><span class="line">    float3 points_i = tex2Dlod(_points, uvInBuffer).rgb;</span><br><span class="line">    //大致的p的计算方法</span><br><span class="line">    p = saturate(p += saturate((distance(worldPos, points_i) - HoleSize) * HoleIndensity));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里计算p值时，不停的在计算旧的射击点的距离，所以希望可以保存上一次计算结果，下一次就直接在上一次结果的基础上进行计算就可以了。<br>目前想到的方法还是需要VTF，可以作为中配机高配机的优化方案。</p><p>方案1：在脚本中做这个计算的话，可以很容易的获取到上次的结果，将结果存入一张贴图，每次有新的射击点就更新这张贴图，shader中直接采样就行。这个方案除了增加采样和写入次数外，会在每次有新的射击点时，遍历整个模型几千甚至上万的顶点，而旧方案每个顶点并行遍历几十个射击点，但这个遍历可能是每帧的。尝试了一下，这个方法在编辑器中都有一些卡，模型有一万多个顶点……</p><p>方案2：另外使用一个摄像机，通过replacementshader来给场景中的对应模型换上特殊的shader，这个shader按顶点uv采样一张贴图的值（得到上一次的p的计算结果），shader用新的射击点计算新的值，将结果按uv位置输出到屏幕空间，摄像机RT就获取到了下次输入shader的贴图。这个方案使得模型顶点间依然是并行的，具体的效率提升还需要测试，在射击次数较多时应该是有优化效果的，不过射击次数一般不会到三位数，不会有很明显的效率提升。</p><h3 id="简化版本"><a href="#简化版本" class="headerlink" title="简化版本"></a>简化版本</h3><p>有些时候，对效率要求比较高，策划可以接受受伤效果都是固定的，就是受攻击到一定程度有固定的地方出现固定的受伤效果。</p><p>针对这个需求的方案：</p><p>美术资源制作中增加一个步骤：<br>在两套uv制作完成后，在sp中按照肢体变化的先后顺序绘制灰度贴图，先变化的肢体部分灰度值越高。<br>如下图的绘制，消失的顺序是手、小腿、头和身子、大腿</p><p><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g5l4mpoxftj31co0pc7cs.jpg" alt></p><p>这张贴图会在 将终点mesh信息烘到起点mesh顶点色的工具中使用，工具中同时导入这张贴图，贴图上的灰度值会存入顶点色的a通道。shader会将射击次数加在这个灰度值上，作为mesh morphing的参数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//  射击脚本中</span><br><span class="line">flag = hitCount / 5;</span><br><span class="line">//  shader中的morphing参数p</span><br><span class="line">p = smoothstep(1.0, 1.2, v.color.a + _flag / 5.0);</span><br></pre></td></tr></table></figure><p>这样做的话iPhone 6s真机测试结果一直相当于之前的0次射击<br><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g5l4obu378j31860o4juj.jpg" alt></p></div><div class="article-tags"><a class="tag-link" href="/tagsfol/Shader/">Shader</a></div></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="https://jinnm.github.io">Codemoph</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a href="https://hexo.io/" rel="external">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix" style="display:none"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc" style="display:none"><div class="no-index">No Index</div></div><div class="site-bio show" style="display:block"><div class="about-me clearfix"><div class="avatar"><img src="/img/avatar.png"></div><div class="info"><a class="name dark-btn" href="/2018/04/29/AboutMe/">Jinnm</a></div><div class="info"><span class="item desc"></span></div></div><div class="social clearfix"></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script>document.getElementById("loading-bar").style.width="100%"</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>